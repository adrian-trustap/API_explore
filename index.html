<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>API Tree Viewer with Highlight Toggle</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
    }
    #controls {
      padding: 10px;
      background: #f8f8f8;
      border-bottom: 1px solid #ddd;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .node circle {
      fill: #555;
    }
    .node text {
      font-size: 12px;
    }
    .link {
      fill: none;
      stroke: #999;
      stroke-opacity: 0.6;
      stroke-width: 1.5px;
    }
  </style>
</head>
<body>
  <div id="controls"></div>
  <svg width="100%" height="100%"></svg>

  <script>
    const highlightTerms = ["transactions", "create", "claim", "complain", "cancel", "accept"]; // ← your keywords

    const color = d3.scaleOrdinal()
      .domain(highlightTerms)
      .range(d3.schemeCategory10);

    let activeTerms = new Set(highlightTerms); // start with all on

    function renderCheckboxes() {
      const controls = d3.select("#controls");
      controls.selectAll("label")
        .data(highlightTerms)
        .join("label")
        .style("margin-right", "10px")
        .html(term => `
          <input type="checkbox" value="${term}" checked> 
          <span style="color:${color(term)}">${term}</span>
        `)
        .on("change", function(event, term) {
          const checked = d3.select(this).select("input").property("checked");
          if (checked) activeTerms.add(term);
          else activeTerms.delete(term);
          updateHighlights();
        });
    }

    function highlightColor(name) {
      const isEndpoint = name.includes("[") && name.includes("]");
      if (!isEndpoint) return null;
      for (let term of activeTerms) {
        if (name.toLowerCase().includes(term.toLowerCase())) {
          return color(term);
        }
      }
      return null;
    }

    const svg = d3.select("svg");
    const g = svg.append("g");

    const zoom = d3.zoom().on("zoom", (event) => {
      g.attr("transform", event.transform);
    });
    svg.call(zoom);

    d3.json("tree.json").then(data => {
      renderCheckboxes();

      const root = d3.hierarchy(data);
      const dx = 20;
      const dy = 200;
      const tree = d3.tree().nodeSize([dx, dy]);
      const diagonal = d3.linkHorizontal()
        .x(d => d.y)
        .y(d => d.x);

      const treeData = tree(root);
      const nodes = treeData.descendants();
      const links = treeData.links();

      const height = Math.max(500, nodes.length * dx * 1.5);
      svg.attr("viewBox", [-dy / 3, -dx, window.innerWidth, height]);

      g.append("g")
        .selectAll("path")
        .data(links)
        .join("path")
        .attr("class", "link")
        .attr("d", diagonal);

      const node = g.append("g")
        .selectAll("g")
        .data(nodes)
        .join("g")
        .attr("class", "node")
        .attr("transform", d => `translate(${d.y},${d.x})`);

      node.append("circle").attr("r", 4);

      node.append("text")
        .attr("dy", "0.31em")
        .attr("x", d => d.children ? -8 : 8)
        .attr("text-anchor", d => d.children ? "end" : "start")
        .text(d => d.data.name)
        .attr("fill", d => highlightColor(d.data.name) || "black")
        .clone(true).lower()
        .attr("stroke", "white");

      // Save reference for later updates
      window.nodeText = node.selectAll("text");
    });

    function updateHighlights() {
      if (!window.nodeText) return;
      window.nodeText.attr("fill", d => highlightColor(d.data.name) || "black");
    }
  </script>
</body>
</html>
